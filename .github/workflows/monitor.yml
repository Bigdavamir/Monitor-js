name: Distributed JS Monitor

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'The root domain to scan (e.g., example.com)'
        required: true
        type: string

jobs:
  # Job 1: Discover all subdomains for the target domain
  discover:
    runs-on: ubuntu-latest
    outputs:
      subdomain_count: ${{ steps.split.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Discovery Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Discover Subdomains
        id: discover
        run: |
          echo "üîç Discovering subdomains for ${{ github.event.inputs.target_domain }}..."
          subfinder -d ${{ github.event.inputs.target_domain }} -silent -o subdomains.txt
          echo "‚úÖ Found $(wc -l < subdomains.txt) subdomains."

      - name: Split subdomains for parallel processing
        id: split
        run: |
          mkdir -p subdomain_chunks
          # Split the subdomains into 20 chunks for the matrix job
          split -d -n l/20 subdomains.txt subdomain_chunks/chunk_
          count=$(ls -1q subdomain_chunks/ | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "‚úÖ Divided subdomains into $count chunks."

      - name: Upload Subdomain Chunks
        uses: actions/upload-artifact@v4
        with:
          name: subdomain-chunks
          path: subdomain_chunks/

  # Job 2: Scan subdomains and download JS files in parallel
  scan:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Create a matrix of 20 parallel runners
        id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Katana
        run: |
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Download Subdomain Chunks Artifact
        uses: actions/download-artifact@v4
        with:
          name: subdomain-chunks
          path: subdomain_chunks

      - name: Run JS Scan Worker
        env:
          SESSION_COOKIE: ${{ secrets.SESSION_COOKIE }}
          MATRIX_ID: ${{ matrix.id }}
        run: |
          chmod +x monitor.sh
          CHUNK_FILE="subdomain_chunks/chunk_$(printf "%02d" ${{ matrix.id }})"
          if [ -f "$CHUNK_FILE" ]; then
            cat "$CHUNK_FILE" | ./monitor.sh "${{ github.event.inputs.target_domain }}"
          else
            echo "‚ÑπÔ∏è No chunk file for this runner, skipping."
          fi

      - name: Upload JS Files Artifact
        uses: actions/upload-artifact@v4
        with:
          name: js-files-batch-${{ matrix.id }}
          path: js_files_temp/

  # Job 3: Consolidate all results, commit changes, and notify
  consolidate:
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Full Git History
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All JS File Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_js_files/
          # Pattern to download all artifacts from the scan job
          pattern: js-files-batch-*
          merge-multiple: true

      - name: Consolidate JS Files
        id: consolidate
        run: |
          TARGET_DIR="js_files/${{ github.event.inputs.target_domain }}"
          mkdir -p "$TARGET_DIR"
          echo "üíø Consolidating all downloaded JS files..."
          # Find all downloaded .js files and copy them to the final directory
          find all_js_files -type f -name "*.js" -exec cp {} "$TARGET_DIR/" \;
          echo "‚úÖ Consolidation complete."

      - name: Commit Changes and Notify
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          TARGET_DOMAIN="${{ github.event.inputs.target_domain }}"
          TARGET_DIR="js_files/$TARGET_DOMAIN"

          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action-bot@github.com"

          git add -A "$TARGET_DIR/"

          if git diff --staged --quiet; then
            echo "‚úÖ No changes detected for $TARGET_DOMAIN. All clear!"
          else
            echo "üö® Changes detected! Committing and pushing updates..."
            git commit -m "[JS Scan] Update files for $TARGET_DOMAIN"
            git pull origin main --rebase
            git push origin main

            if [ -z "$DISCORD_WEBHOOK_URL" ]; then
              echo "‚ö†Ô∏è DISCORD_WEBHOOK_URL not set. Skipping notification."
            else
              echo "üì¢ Sending Discord notification..."
              COMMIT_HASH=$(git rev-parse HEAD)
              COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$COMMIT_HASH"
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

              JSON_PAYLOAD=$(printf '{
                "embeds": [{
                  "title": "üö® New JavaScript Changes Detected!", "color": 16711680,
                  "fields": [
                    {"name": "Target Domain", "value": "%s", "inline": true},
                    {"name": "Commit Link", "value": "[View Commit](%s)", "inline": true}
                  ], "footer": {"text": "Scan completed"}, "timestamp": "%s"
                }]
              }' "$TARGET_DOMAIN" "$COMMIT_URL" "$TIMESTAMP")

              curl -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK_URL"
              echo "‚úÖ Notification sent."
            fi
          fi