# This workflow acts as the main controller for the JS monitoring system.
# It handles triggers (manual and scheduled) and calls the reusable scan pipeline
# for the appropriate target environments.
name: JS Monitor Controller

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Select the target environment to scan manually'
        type: environment
        required: true

  schedule:
    - cron: '0 */12 * * *'

jobs:
  # This job handles a single scan, triggered manually from the UI.
  manual_scan:
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/_reusable-scan-pipeline.yml # <-- FINAL FIX: @main removed
    with:
      environment_name: ${{ github.event.inputs.target_environment }}
    secrets: inherit

  # For scheduled runs, this job reads active_targets.txt to get the list of targets.
  read_scheduled_targets:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-file.outputs.json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Read active_targets.txt and format as JSON
        id: read-file
        run: |
          if [ ! -f active_targets.txt ]; then
            echo "active_targets.txt not found. No scheduled scans will run."
            echo "json=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          JSON_ARRAY=$(cat active_targets.txt | grep -vE '^\s*#|^\s*$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "json=${JSON_ARRAY}" >> $GITHUB_OUTPUT
          echo "Scheduled targets found: ${JSON_ARRAY}"

  # This job runs the scan pipeline in parallel for each scheduled target.
  scheduled_scan_matrix:
    needs: read_scheduled_targets
    if: github.event_name == 'schedule' && needs.read_scheduled_targets.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.read_scheduled_targets.outputs.matrix) }}
    uses: ./.github/workflows/_reusable-scan-pipeline.yml # <-- FINAL FIX: @main removed
    with:
      environment_name: ${{ matrix.target }}
    secrets: inherit
